<script>
	import Markdown from '@components/Markdown.svelte';
	import Graph from '@components/Graph.svelte';
	import ItemDetail from '@components/ItemDetail.svelte';
	import { page } from '$app/stores';
	import { Api, items, graphSteps, selectedNode } from '@stores';
	import { onMount } from 'svelte';
	import { extractLinks, createTriplets } from '@utils';
	import { writable } from 'svelte/store';

	export let data;
	let textData = [];
	let triplets, itemsJson;
	let visibleItemsID = [];
	let essaysItems = [];

	const updatePosition = writable(false);
	const handlePosition = () => {
		$updatePosition = true;
	};

	$: {
		$selectedNode;
		handlePosition();
	}

	onMount(async () => {
		textData = [...data.posts].find((d) => d.path.includes($page.params.slug));
		itemsJson = await extractLinks(textData.text);
		visibleItemsID = itemsJson
			.filter((obj) => !obj.set)
			.map((obj) => `${Api}/resources/${obj.data?.['o:id']}`);
		triplets = await createTriplets(itemsJson);
		$items = triplets;


		essaysItems = data.posts.reduce((result, item) => {
			if (!item.path.includes($page.params.slug)) {
				item.links.map((link) => {
					const existingEntry = result.find((entry) => entry.id === link);

					const essay = {
						title: item.meta.title,
						url: item.path
					};

					if (existingEntry) {
						// Check if the essay doesn't already exist in the 'essays' array
						if (
							!existingEntry.essays.some(
								(existingEssay) =>
									existingEssay.title === essay.title && existingEssay.url === essay.url
							)
						) {
							existingEntry.essays.push(essay);
						}
					} else {
						result.push({
							id: link,
							essays: [essay]
						});
					}
				});
			}
			return result;
		}, []);
	});

	function resetNode() {
		$graphSteps = [];
	}
</script>

<svelte:window on:resize={handlePosition} on:scroll={handlePosition} />
<div>
	{#if textData == undefined && triplets == undefined}
		<article>
			<section class="markdown__container">
				<h4>404 Page not found</h4>
			</section>
		</article>
	{:else if triplets == undefined}
		<article>
			<section class="markdown__container">
				<h4>Loading...</h4>
			</section>
		</article>
	{:else}
		<article style="--theme-color: {textData.meta?.color || 'blue'}">
			<section
				class="item__detail"
				on:click={() => {
					document.querySelectorAll('a[data-id]').forEach((link) => {
						link.classList.remove('related');
						link.classList.remove('selected');
					});
					resetNode();
					handlePosition();
				}}
				on:keypress={handlePosition}
			>
				<ItemDetail data={itemsJson.filter((d) => !d.hasOwnProperty('fromSet'))} />
			</section>
			<section
				class="markdown__container"
				on:wheel={() => {
					resetNode();
					handlePosition();
				}}
				on:touchmove={() => {
					resetNode();
					handlePosition();
				}}
				on:click={() => {
					resetNode();
					handlePosition();
				}}
				on:keypress={handlePosition}
			>
				<h1>{textData.meta.title}</h1>
				<Markdown data={textData} items={itemsJson} />
			</section>
			<section class="graph__container" on:click={handlePosition} on:keypress={handlePosition}>
				<Graph {essaysItems} data={$items} {visibleItemsID} {handlePosition} {updatePosition} />
			</section>
		</article>
	{/if}
</div>

<style>
	article {
		display: flex;
		height: calc(100vh - 1rem);
		position: relative;
	}

	h1 {
		margin-top: 0.5rem;
		margin-bottom: 1rem;
		font-size: 2.4rem;
	}

	.markdown__container {
		padding: 0.5rem 0rem 0 1rem;
		/* flex: 0 0 600px; */
		max-width: 600px;
		flex: 0 0 40vw;
		overflow-x: scroll;
	}

	.graph__container {
		flex: 3;
	}

	.item__detail {
		/* flex: 0 0 400px; */
		flex: 0 0 20vw;
		max-width: 400px;
		border-right: 1px solid #e3e3e3;
	}

	@media only screen and (max-width: 600px) {
		article {
			height: 180vh;
		}
		.markdown__container {
			flex: 2;
			padding: 0.5rem;
		}

		h1 {
			font-size: 1.4rem;
		}

		div::before {
			content: 'This website contains visualizations that are not supported by small screen formats. To navigate the graphs, go to your desktop browser.';
			display: block;
			font-size: 20px;
			padding: 1rem;
			background: blue;
		}

		.item__detail {
			flex: 1;
			/* display: none; */
		}

		.graph__container {
			display: none;
		}
	}
</style>
